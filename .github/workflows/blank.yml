name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# âœ… Explicitly scoped permissions (fixes CKV2_GHA_1)
permissions:
  contents: read   # Only allow read access to repository contents

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov Scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: all
          quiet: true

      - name: Build Nginx Docker image
        run: |
          docker build -t my-nginx .

      - name: Run Nginx container
        run: |
          docker run -d -p 8080:80 --name nginx_test my-nginx
          sleep 5
          curl -f http://localhost:8080 || (docker logs nginx_test && exit 1)

      - name: Cleanup
        run: |
          docker stop nginx_test
          docker rm nginx_test
