name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - uses: actions/checkout@v4

      # Run Checkov to scan IaC / Dockerfile / configs
      - name: Run Checkov Scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: all  # scans Terraform, K8s, Dockerfile, CloudFormation etc.
          quiet: true

      # Build Docker image for Nginx webserver
      - name: Build Nginx Docker image
        run: |
          docker build -t my-nginx .

      # Run container (detached) and check it responds
      - name: Run Nginx container
        run: |
          docker run -d -p 8080:80 --name nginx_test my-nginx
          sleep 5
          curl -f http://localhost:8080 || (docker logs nginx_test && exit 1)

      # Stop and cleanup container
      - name: Cleanup
        run: |
          docker stop nginx_test
          docker rm nginx_test
